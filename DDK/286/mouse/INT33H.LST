Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-1


					page	,132
				;-----------------------------Module-Header-----------------------------;
				; Module Name:	INT33H.ASM
				;
				; Windows mouse driver data and initialization routines for using the
				; INT 33h mouse driver for Windows
				;
				; Created: 21-Aug-1987
				; Author:  Mr. Mouse [mickeym], Walt Moore [waltm]
				;
				; Copyright (c) 1987  Microsoft Corporation
				;
				; Exported Functions:
				;	None
				; Public Functions:
				;	I33_enable
				;	I33_disable
				;	I33_init
				; Public Data:
				;	None
				; General Description:
				;	This module contains the functions to find, enable, disable,
				;	and process interrupts for the INT 33h mouse handler.
				;-----------------------------------------------------------------------;
				
				
					title	Microsoft OS/2 INT 33h Dependent Code
				
					.list
				
				
				sBegin	Data
 0000                        2	_DATA segment 
				
				externD event_proc			;Mouse event procedure when enabled
				externB device_int			;Start of mouse interrupt handler
				externB mouse_flags			;Various flags
				externW enable_proc			;Address of routine to	enable mouse
				externW disable_proc			;Address of routine to disable mouse
				
				sEnd	Data
 0000                        1	_DATA ends 
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-2


				page
				
				sBegin	Code
 0000                        2	_TEXT segment 
				assumes cs,Code
				
				;	This is the start of the data which will be copied into
				;	the device_int area reserved in the data segment.  References
				;	to defined memory locations must be made relative to device_int
				
					even
				
 = 0000				I33_START	equ	this word
				
				
				;--------------------------Interrupt-Routine----------------------------;
				; I33_proc - Mouse Interrupt Handler
				;
				; This is the handler for the interrupt generated by the INT 33h
				; mouse driver.  It will reside in the Data segment.
				;
				; Entry:
				;	BL = current button status
				;	  D0 = 1 if button 1 is down
				;	  D1 = 1 if button 2 is down
				;	SI = delta X
				;	DI = delta Y
				; Returns:
				;	None
				; Error Returns:
				;	None
				; Registers Preserved:
				;	DS,BP
				; Registers Destroyed:
				;	AX,BX,CX,DX,SI,DI,ES,FLAGS
				; Calls:
				;	event_proc if valid mouse event
				; History:
				;	Fri 21-Aug-1987 11:43:42 -by-  Walt Moore [waltm] & Mr. Mouse
				;	Initial version
				;-----------------------------------------------------------------------;
				
				;------------------------------Pseudo-Code------------------------------;
				; {
				; }
				;-----------------------------------------------------------------------;
				
					assumes cs,Code
					assumes ds,nothing
					assumes es,nothing
					assumes ss,nothing
				
				
 = 0000				I33_PROC_START	equ	$-I33_START	;Delta to this procedure
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-3


				
 0000				I33_proc	proc	far
				
 0000  B8 ---- R			mov	ax,_DATA		 ;Need to gain access to our
 0003  8E D8				mov	ds,ax			;  data segment
					assumes ds,Data
				
 0005  83 E3 03				and	bx,00000011b			;Isolate buttons, set BH = 0
 0008  8A F3				mov	dh,bl				;Get and update mouse state
 000A  86 36 003D E			xchg	dh,bptr device_int[OLD_STATE]	;1 indicates button down
 000E  D0 E6				shl	dh,1				;Shift old state
 0010  D0 E6				shl	dh,1
 0012  0A DE				or	bl,dh				;Combine states into index
				
				;	mov	bl,deltas_states[bx]	;Get button delta/states, BH = 0
 0014  8A 9F 003E E			mov	bl,bptr device_int[STATE_XLATE][bx]
				
 0018  8B CF				mov	cx,di			;CX = delta Y
 001A  0B CE				or	cx,si			;Show motion if any occured
 001C  F7 D9				neg	cx			;'C' clear only if motion (DI ne 0)
 001E  13 DB				adc	bx,bx
 0020  74 14				jz	I33_nothing_happened
					.errnz	SF_MOVEMENT-00000001b
				
 0022  B8 000B				mov	ax,CLEAR_COUNTERS	;Clear dX and dY counters			   ;clear dX
				 & dY counters
 0025  CD 33				int	MOUSE_SYS_VEC		;BX,SI,DI are preserved
				
 0027  8B CF				mov	cx,di			;CX = delta Y
 0029  96				xchg	ax,si			;AX = delta X
 002A  93				xchg	ax,bx			;AX = status, BX = delta X
 002B  BA 0002				mov	dx,NUMBER_BUTTONS
 002E  33 F6			        xor     si,si			;Zero out MessageExtraInfo for 3.1
 0030  33 FF			        xor     di,di
 0032  FF 1E 0000 E			call	event_proc
				
 0036				I33_nothing_happened:
				
 0036  CB				ret
				
 0037				I33_proc	endp
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-4


				page
				
				;	old_int_33h areas contain the information required to
				;	restore the previous INT 33h event handler when we
				;	finally disable ourselves.
				
 = 0037				OLD_INT_33H_MASK equ	$-I33_START	;Delta to this byte
 0037  0000					dw	0		;Old INT 33h procedure mask
				
 = 0039				OLD_INT_33H_PROC equ	$-I33_START	;Delta to this byte
 0039  00000000					dd	0		;Old INT 33h procedure address
				
				
				;	old_status contains the state of the mouse the last time we
				;	were called to process an interrupt.
				
 = 003D				OLD_STATE	equ	$-I33_START	;Delta to this byte
 003D  00					db	0		;Old status will go here
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-5


				page
				
				;-----------------------------------------------------------------------;
				; state_xlate
				;
				;	state_xlate is used to translate the current and previous
				;	button state information into the values required by
				;	Windows.  It is indexed as follows:
				;
				;	    pB2 pB1 cB2 cB1
				;
				;	     |	 |   |	 |
				;	     |	 |   |	  --- 1 if button 1 is	down, 0 if button 1 is	up
				;	     |	 |   |
				;	     |	 |    ------- 1 if button 2 is	down, 0 if button 2 is	up
				;	     |	 |
				;	     |	  ----------- 1 if button 1 was down, 0 if button 1 was up
				;	     |
				;	      --------------- 1 if button 2 was down, 0 if button 2 was up
				;
				;	This table must be copied to the data segment along with the
				;	interrupt handler.
				;
				;-----------------------------------------------------------------------;
				
 = 003E				STATE_XLATE	equ	$-I33_START	;delta to this table
				
 003E  00				db	0			shr 1
 003F  01				db	(SF_B1_DOWN)		shr 1
 0040  04				db	(SF_B2_DOWN)		shr 1
 0041  05				db	(SF_B1_DOWN+SF_B2_DOWN) shr 1
				
 0042  02				db	(SF_B1_UP)		shr 1
 0043  00				db	0			shr 1
 0044  06				db	(SF_B1_UP+SF_B2_DOWN)	shr 1
 0045  04				db	(SF_B2_DOWN)		shr 1
				
 0046  08				db	(SF_B2_UP)		shr 1
 0047  09				db	(SF_B1_DOWN+SF_B2_UP)	shr 1
 0048  00				db	0			shr 1
 0049  01				db	(SF_B1_DOWN)		shr 1
				
 004A  0A				db	(SF_B1_UP+SF_B2_UP)	shr 1
 004B  08				db	(SF_B2_UP)		shr 1
 004C  02				db	(SF_B1_UP)		shr 1
 004D  00				db	0			shr 1
				
					.errnz	NUMBER_BUTTONS-2	;Won't work unless a two button mouse
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-6


				page
				
 = 004E				I33_INT_LENGTH	= $-I33_START		;Length of code to copy
					.errnz	I33_INT_LENGTH gt MAX_INT_SIZE
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-7


				page
				
				;---------------------------Public-Routine------------------------------;
				; I33_enable - Enable the INT 33h mouse handler
				;
				; The INT 33h mouse code will be requested to call our handler for
				; all mouse events.  The previous event mask and event procedure will
				; be saved for the restore code.
				;
				; Entry:
				;	None
				; Returns:
				;	None
				; Error Returns:
				;	None
				; Registers Preserved:
				;	DS,BP
				; Registers Destroyed:
				;	AX,BX,CX,DX,SI,DI,ES,FLAGS
				; Calls:
				;	INT 33h
				; History:
				;	Fri 21-Aug-1987 11:43:42 -by-  Walt Moore [waltm] & Mr. Mouse
				;	Initial version
				;-----------------------------------------------------------------------;
				
				;------------------------------Pseudo-Code------------------------------;
				; {
				; }
				;-----------------------------------------------------------------------;
				
					assumes cs,Code
					assumes ds,Data
				
 004E				I33_enable	proc	near
				
 004E  C6 06 003D E 00			mov	bptr device_int[OLD_STATE],0
				
 0053  1E				push	ds			;ES:DX --> interrupt procedure
 0054  07				pop	es
					assumes es,Data
				
 0055  8D 16 0000 E			lea	dx,device_int[I33_PROC_START]
 0059  B9 001F				mov	cx,CALL_ON_ANY_INT	;Call us on any event
 005C  B8 0014				mov	ax,SWAP_INT_PROC	;Swap interrupt routine
 005F  CD 33				int	MOUSE_SYS_VEC
				
 0061  89 0E 0037 E			mov	wptr device_int[OLD_INT_33H_MASK],cx
 0065  89 16 0039 E			mov	wptr device_int[OLD_INT_33H_PROC][0],dx
 0069  8C 06 003B E			mov	wptr device_int[OLD_INT_33H_PROC][2],es
 006D  C3				ret
				
 006E				I33_enable	endp
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-8


				page
				
				;---------------------------Public-Routine------------------------------;
				; I33_disable - Disable the INT 33h mouse handler
				;
				; The INT 33h mouse handler will be disabled from calling us.  The
				; previous event mask and event procedure will be restored.
				;
				; Entry:
				;	None
				; Returns:
				;	None
				; Error Returns:
				;	None
				; Registers Preserved:
				;	DS,BP
				; Registers Destroyed:
				;	AX,BX,CX,DX,SI,DI,ES,FLAGS
				; Calls:
				;	INT 33h
				; History:
				;	Fri 21-Aug-1987 11:43:42 -by-  Walt Moore [waltm] & Mr. Mouse
				;	Initial version
				;-----------------------------------------------------------------------;
				
				;------------------------------Pseudo-Code------------------------------;
				; {
				; }
				;-----------------------------------------------------------------------;
				
					assumes cs,Code
					assumes ds,Data
				
 006E				I33_disable	proc	near
				
 006E  B8 000C				mov	ax,BASH_INT_PROC
 0071  8B 0E 0037 E			mov	cx,wptr device_int[OLD_INT_33H_MASK]
 0075  C4 16 0039 E			les	dx,dptr device_int[OLD_INT_33H_PROC]
					assumes es,nothing
 0079  CD 33				int	MOUSE_SYS_VEC
				
 007B  C3				ret
				
 007C				I33_disable	endp
				
				
				
				;---------------------------Public-Routine------------------------------;
				; I33_init - Initialize the INT 33h mouse handler
				;
				; Store the enable and disable procedure addresses where the interrupt
				; procedure can find them.  Return the information needed for the caller
				; to copy the interrupt procedure to the data segment.
				;
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Page     1-9


				; Entry:
				;	None
				; Returns:
				;	None
				; Error Returns:
				;	None
				; Registers Preserved:
				;	DS,BP
				; Registers Destroyed:
				;	AX,BX,CX,DX,SI,DI,ES,FLAGS
				; Calls:
				;	INT 33h
				; History:
				;	Thu 17-Sep-1987 22:19:00 -by-  Bob Grudem [bobgru]
				;	Coded final pieces.
				;	Fri 21-Aug-1987 11:43:42 -by-  Walt Moore [waltm] & Mr. Mouse
				;	Initial version
				;-----------------------------------------------------------------------;
				
				;------------------------------Pseudo-Code------------------------------;
				; {
				; }
				;-----------------------------------------------------------------------;
				
					assumes cs,Code
					assumes ds,Data
				
					public	I33_init
 007C				I33_init	proc	near
				
 007C  C7 06 0000 E 004E R		mov	enable_proc, CodeOFFSET I33_enable
 0082  C7 06 0000 E 006E R		mov	disable_proc,CodeOFFSET I33_disable
 0088  BE 0000 R			mov	si,CodeOFFSET I33_START
 008B  B9 004E				mov	cx,I33_INT_LENGTH
 008E  C3				ret
 008F				I33_init	endp
				
				sEnd	Code
 008F                        1	_TEXT ends 
				end

Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Symbols-1


Macros:

		N a m e			Lines

display_int_size . . . . . . . .  	   3
io_delay . . . . . . . . . . . .  	   3

Segments and Groups:

                N a m e         	Length	 Align	Combine Class

BIOSDataSeg  . . . . . . . . . .  	006D	AT	0040	
DGROUP . . . . . . . . . . . . .  	GROUP
  _DATA  . . . . . . . . . . . .  	0000	WORD	PUBLIC	'DATA'
_TEXT  . . . . . . . . . . . . .  	008F	WORD	PUBLIC	'CODE'

Symbols:            

                N a m e         	Type	 Value	 Attr

ACK_PORT . . . . . . . . . . . .  	NUMBER	0020	
ACK_SLAVE_PORT . . . . . . . . .  	NUMBER	00A0	

BASH_INT_PROC  . . . . . . . . .  	NUMBER	000C	
bios_time  . . . . . . . . . . .  	L BYTE	006C	BIOSDataSeg
bptr . . . . . . . . . . . . . .  	TEXT  byte ptr		

CALL_ON_ANY_INT  . . . . . . . .  	NUMBER	001F	
CLEAR_COUNTERS . . . . . . . . .  	NUMBER	000B	
CodeBASE . . . . . . . . . . . .  	ALIAS	 _TEXT		
CodeOFFSET . . . . . . . . . . .  	TEXT  offset _TEXT:		

DataBASE . . . . . . . . . . . .  	ALIAS	 DGROUP		
DataOFFSET . . . . . . . . . . .  	TEXT  offset DGROUP:		
device_int . . . . . . . . . . .  	V BYTE	0000	_DATA	External
disable_proc . . . . . . . . . .  	V WORD	0000	_DATA	External
dptr . . . . . . . . . . . . . .  	TEXT  dword ptr		

EOI  . . . . . . . . . . . . . .  	NUMBER	0020	
enable_proc  . . . . . . . . . .  	V WORD	0000	_DATA	External
event_proc . . . . . . . . . . .  	V DWORD	0000	_DATA	External

I33_INT_LENGTH . . . . . . . . .  	NUMBER	004E	
I33_PROC_START . . . . . . . . .  	NUMBER	0000	
I33_START  . . . . . . . . . . .  	WORD	0000	_TEXT
I33_disable  . . . . . . . . . .  	N PROC	006E	_TEXT	Length = 000E
I33_enable . . . . . . . . . . .  	N PROC	004E	_TEXT	Length = 0020
I33_init . . . . . . . . . . . .  	N PROC	007C	_TEXT	Global	Length = 0013
I33_nothing_happened . . . . . .  	L NEAR	0036	_TEXT
I33_proc . . . . . . . . . . . .  	F PROC	0000	_TEXT	Length = 0037
INT33H_BUS . . . . . . . . . . .  	NUMBER	0001	
INT33H_ENABLE  . . . . . . . . .  	NUMBER	0020	
INT33H_GETINFO . . . . . . . . .  	NUMBER	0024	
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Symbols-2


INT33H_HP  . . . . . . . . . . .  	NUMBER	0005	
INT33H_INPORT  . . . . . . . . .  	NUMBER	0003	
INT33H_PS_2  . . . . . . . . . .  	NUMBER	0004	
INT33H_RESET . . . . . . . . . .  	NUMBER	0000	
INT33H_SERIAL  . . . . . . . . .  	NUMBER	0002	
INT_REQUEST  . . . . . . . . . .  	NUMBER	000A	
IN_SERVICE . . . . . . . . . . .  	NUMBER	000B	

MASK_PORT  . . . . . . . . . . .  	NUMBER	0021	
MASK_SLAVE_PORT  . . . . . . . .  	NUMBER	00A1	
MAX_INT_SIZE . . . . . . . . . .  	NUMBER	00D2	
MF_ENABLED . . . . . . . . . . .  	NUMBER	0001	
MF_INT33H  . . . . . . . . . . .  	NUMBER	0002	
MF_MOUSE_EXISTS  . . . . . . . .  	NUMBER	0080	
MF_ON_SLAVEPIC . . . . . . . . .  	NUMBER	0040	
MOUSE_SYS_VEC  . . . . . . . . .  	NUMBER	0033	
MT_BUS . . . . . . . . . . . . .  	NUMBER	0001	
MT_HP  . . . . . . . . . . . . .  	NUMBER	0005	
MT_INPORT  . . . . . . . . . . .  	NUMBER	0003	
MT_NO_MOUSE  . . . . . . . . . .  	NUMBER	0000	
MT_PS2 . . . . . . . . . . . . .  	NUMBER	0004	
MT_SERIAL  . . . . . . . . . . .  	NUMBER	0002	
mouse_flags  . . . . . . . . . .  	V BYTE	0000	_DATA	External

NUMBER_BUTTONS . . . . . . . . .  	NUMBER	0002	

OLD_INT_33H_MASK . . . . . . . .  	NUMBER	0037	
OLD_INT_33H_PROC . . . . . . . .  	NUMBER	0039	
OLD_STATE  . . . . . . . . . . .  	NUMBER	003D	

rs232_data . . . . . . . . . . .  	L WORD	0000	BIOSDataSeg	Length = 0004

SF_ABSOLUTE  . . . . . . . . . .  	NUMBER	8000	
SF_B1_DOWN . . . . . . . . . . .  	NUMBER	0002	
SF_B1_UP . . . . . . . . . . . .  	NUMBER	0004	
SF_B2_DOWN . . . . . . . . . . .  	NUMBER	0008	
SF_B2_UP . . . . . . . . . . . .  	NUMBER	0010	
SF_MOVEMENT  . . . . . . . . . .  	NUMBER	0001	
STATE_XLATE  . . . . . . . . . .  	NUMBER	003E	
SWAP_INT_PROC  . . . . . . . . .  	NUMBER	0014	

VMD_DEVICE_ID  . . . . . . . . .  	NUMBER	000C	

WF_PMODE . . . . . . . . . . . .  	NUMBER	0001	
wptr . . . . . . . . . . . . . .  	TEXT  word ptr		

X_SPEED  . . . . . . . . . . . .  	NUMBER	0002	

Y_SPEED  . . . . . . . . . . . .  	NUMBER	0002	

?386regs . . . . . . . . . . . .  	NUMBER	0000	
@Cpu . . . . . . . . . . . . . .  	TEXT  1415		
@FileName  . . . . . . . . . . .  	TEXT  int33h		
@Version . . . . . . . . . . . .  	TEXT  510		
Microsoft (R) Macro Assembler Version 5.10A                 1/7/26 00:09:12

Microsoft OS/2 INT 33h Dependent Code                       Symbols-3


__ROMBIOS  . . . . . . . . . . .  	NUMBER	0000		Communal


   1895 Source  Lines
   2430 Total   Lines
    261 Symbols

  46124 Bytes symbol space free

      0 Warning Errors
      0 Severe  Errors
